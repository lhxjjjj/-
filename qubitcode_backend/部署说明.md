# QubitCode 后端部署说明

## 环境要求

- Python 3.8+
- MySQL 5.7+ / 8.0+
- Redis (可选，用于缓存)

## 部署步骤

### 1. 克隆项目

```bash
git clone <repository-url>
cd qubitcode_backend
```

### 2. 创建虚拟环境

```bash
python -m venv venv

# Windows
venv\Scripts\activate

# Linux/Mac
source venv/bin/activate
```

### 3. 安装依赖

```bash
pip install -r requirements.txt
```

### 4. 配置环境变量

复制环境变量示例文件并根据实际情况修改：

```bash
cp .env.example .env
```

编辑 `.env` 文件，设置以下关键变量：

```env
# 数据库配置
DATABASE_URL=mysql+pymysql://username:password@localhost/qubitcode

# Flask配置
FLASK_ENV=production
SECRET_KEY=your-secret-key-here

# API配置
API_VERSION=v1
API_PREFIX=/api/v1

# CORS配置
CORS_ORIGINS=http://localhost:3000,http://yourdomain.com

# 日志配置
LOG_LEVEL=INFO
LOG_FILE=logs/app.log

# 聊天功能限制
MAX_MESSAGES_PER_CHAT=100
MAX_CHAT_DURATION_HOURS=24
```

### 5. 创建数据库

在MySQL中创建数据库：

```sql
CREATE DATABASE qubitcode CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

### 6. 初始化数据库

```bash
# 初始化数据库迁移
python setup_migrations.py

# 或者直接初始化数据库（不使用迁移）
python init_db.py
```

### 7. 测试运行

```bash
python app.py
```

访问 `http://localhost:5000` 检查API是否正常运行。

### 8. 生产部署

#### 使用 Gunicorn (推荐)

```bash
pip install gunicorn

# 启动应用
gunicorn -w 4 -b 0.0.0.0:5000 app:app
```

#### 使用 uWSGI

```bash
pip install uwsgi

# 创建 uwsgi 配置文件
cat > uwsgi.ini << EOF
[uwsgi]
module = app:app
master = true
processes = 4
socket = /tmp/qubitcode.sock
chmod-socket = 666
vacuum = true
die-on-term = true
EOF

# 启动应用
uwsgi --ini uwsgi.ini
```

#### 使用 Docker

创建 `Dockerfile`:

```dockerfile
FROM python:3.9-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

EXPOSE 5000

CMD ["gunicorn", "-w", "4", "-b", "0.0.0.0:5000", "app:app"]
```

创建 `docker-compose.yml`:

```yaml
version: '3.8'

services:
  web:
    build: .
    ports:
      - "5000:5000"
    environment:
      - DATABASE_URL=mysql+pymysql://root:password@db:3306/qubitcode
      - FLASK_ENV=production
    depends_on:
      - db
    volumes:
      - ./logs:/app/logs

  db:
    image: mysql:8.0
    environment:
      - MYSQL_ROOT_PASSWORD=password
      - MYSQL_DATABASE=qubitcode
    volumes:
      - mysql_data:/var/lib/mysql
    ports:
      - "3306:3306"

volumes:
  mysql_data:
```

启动服务：

```bash
docker-compose up -d
```

## Nginx 配置

创建 Nginx 配置文件 `/etc/nginx/sites-available/qubitcode`:

```nginx
server {
    listen 80;
    server_name yourdomain.com;

    location / {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 静态文件缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

启用站点：

```bash
sudo ln -s /etc/nginx/sites-available/qubitcode /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

## SSL 证书配置

使用 Let's Encrypt 获取免费SSL证书：

```bash
sudo apt install certbot python3-certbot-nginx
sudo certbot --nginx -d yourdomain.com
```

## 监控和日志

### 日志配置

应用日志存储在 `logs/app.log`，使用 logrotate 进行日志轮转：

创建 `/etc/logrotate.d/qubitcode`:

```
/path/to/qubitcode_backend/logs/*.log {
    daily
    missingok
    rotate 52
    compress
    notifempty
    create 644 www-data www-data
    postrotate
        systemctl reload qubitcode
    endscript
}
```

### 系统服务配置

创建 systemd 服务文件 `/etc/systemd/system/qubitcode.service`:

```ini
[Unit]
Description=QubitCode API Server
After=network.target

[Service]
User=www-data
Group=www-data
WorkingDirectory=/path/to/qubitcode_backend
Environment=PATH=/path/to/qubitcode_backend/venv/bin
ExecStart=/path/to/qubitcode_backend/venv/bin/gunicorn -w 4 -b 127.0.0.1:5000 app:app
ExecReload=/bin/kill -s HUP $MAINPID
Restart=always

[Install]
WantedBy=multi-user.target
```

启用并启动服务：

```bash
sudo systemctl enable qubitcode
sudo systemctl start qubitcode
```

## 性能优化

### 数据库优化

1. 为常用查询字段添加索引：

```sql
-- 为联系表单的email字段添加索引
CREATE INDEX idx_contacts_email ON contacts(email);

-- 为聊天会话的session_id字段添加索引
CREATE INDEX idx_chats_session_id ON chats(session_id);

-- 为聊天消息的chat_id字段添加索引
CREATE INDEX idx_chat_messages_chat_id ON chat_messages(chat_id);
```

2. 配置MySQL缓存：

```sql
SET GLOBAL query_cache_size = 268435456; -- 256MB
SET GLOBAL query_cache_type = ON;
```

### 缓存配置

使用Redis进行缓存：

安装依赖：

```bash
pip install redis
```

在 `.env` 文件中添加Redis配置：

```env
REDIS_URL=redis://localhost:6379/0
CACHE_TYPE=redis
CACHE_DEFAULT_TIMEOUT=300
```

### 应用优化

1. 使用连接池：

```python
# 在 config.py 中添加
SQLALCHEMY_ENGINE_OPTIONS = {
    'pool_size': 10,
    'pool_recycle': 120,
    'pool_pre_ping': True
}
```

2. 启用Gzip压缩：

```python
# 在 app.py 中添加
from flask_compress import Compress
Compress(app)
```

## 安全配置

1. 防火墙配置：

```bash
sudo ufw allow ssh
sudo ufw allow 80
sudo ufw allow 443
sudo ufw enable
```

2. 定期更新依赖：

```bash
pip install pip-tools
pip-compile requirements.in
pip-sync requirements.txt
```

3. 安全头配置：

```python
# 在 app.py 中添加
from flask_talisman import Talisman
Talisman(app, force_https=True)
```

## 备份策略

### 数据库备份

创建备份脚本 `backup.sh`:

```bash
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/path/to/backups"
DB_NAME="qubitcode"
DB_USER="username"
DB_PASS="password"

mkdir -p $BACKUP_DIR

# 创建数据库备份
mysqldump -u $DB_USER -p$DB_PASS $DB_NAME | gzip > $BACKUP_DIR/db_backup_$DATE.sql.gz

# 删除7天前的备份
find $BACKUP_DIR -name "db_backup_*.sql.gz" -mtime +7 -delete

echo "Database backup completed: $BACKUP_DIR/db_backup_$DATE.sql.gz"
```

设置定时任务：

```bash
crontab -e
# 添加以下行，每天凌晨2点执行备份
0 2 * * * /path/to/backup.sh
```

## 故障排除

### 常见问题

1. **数据库连接失败**

   检查 `.env` 文件中的数据库配置是否正确，确保数据库服务正在运行。

2. **端口占用**

   使用以下命令检查端口占用情况：

   ```bash
   sudo netstat -tlnp | grep :5000
   ```

3. **权限问题**

   确保应用有足够的权限写入日志文件和上传目录：

   ```bash
   sudo chown -R www-data:www-data /path/to/qubitcode_backend
   sudo chmod -R 755 /path/to/qubitcode_backend
   ```

4. **内存不足**

   如果服务器内存不足，可以减少Gunicorn工作进程数量：

   ```bash
   gunicorn -w 2 -b 0.0.0.0:5000 app:app
   ```

### 日志分析

查看应用日志：

```bash
tail -f logs/app.log
```

查看Nginx日志：

```bash
tail -f /var/log/nginx/access.log
tail -f /var/log/nginx/error.log
```

查看系统日志：

```bash
journalctl -u qubitcode -f
```

## 更新部署

1. 拉取最新代码：

```bash
git pull origin main
```

2. 更新依赖：

```bash
pip install -r requirements.txt
```

3. 应用数据库迁移：

```bash
flask db upgrade
```

4. 重启服务：

```bash
sudo systemctl restart qubitcode
```

## 联系支持

如果在部署过程中遇到问题，请联系技术支持：

- 邮箱：support@qubitcode.com
- 文档：https://docs.qubitcode.com
- 社区：https://community.qubitcode.com